<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Door Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .scan-count {
            background: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        /* Setup Panel */
        .setup-panel {
            background: #252542;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .setup-panel.collapsed {
            padding: 12px 16px;
        }
        
        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .setup-header h2 {
            font-size: 16px;
            font-weight: 500;
        }
        
        .setup-content {
            margin-top: 16px;
        }
        
        .setup-panel.collapsed .setup-content {
            display: none;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1a1a2e;
            color: white;
            font-size: 16px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #444;
            color: white;
        }
        
        /* Direction Toggle */
        .direction-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .direction-btn {
            flex: 1;
            padding: 20px;
            border: 3px solid transparent;
            border-radius: 12px;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .direction-btn.in {
            background: #1b4332;
            color: #4CAF50;
        }
        
        .direction-btn.in.active {
            background: #4CAF50;
            color: white;
            border-color: #81c784;
        }
        
        .direction-btn.out {
            background: #442222;
            color: #f44336;
        }
        
        .direction-btn.out.active {
            background: #f44336;
            color: white;
            border-color: #e57373;
        }
        
        /* Scanner */
        .scanner-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }
        
        #reader {
            width: 100%;
        }
        
        #reader video {
            border-radius: 12px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #4CAF50;
            border-radius: 12px;
            pointer-events: none;
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .status.ready {
            background: #252542;
            color: #888;
        }
        
        .status.success {
            background: #1b4332;
            color: #4CAF50;
        }
        
        .status.error {
            background: #442222;
            color: #f44336;
        }
        
        .status.scanning {
            background: #2a2a4a;
            color: #64b5f6;
        }
        
        /* Recent Scans */
        .recent-scans {
            background: #252542;
            border-radius: 12px;
            padding: 16px;
        }
        
        .recent-scans h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .scan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .scan-item:last-child {
            margin-bottom: 0;
        }
        
        .scan-item .direction {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .scan-item .direction.in {
            color: #4CAF50;
        }
        
        .scan-item .direction.out {
            color: #f44336;
        }
        
        .scan-item .id {
            flex: 1;
            font-weight: 500;
        }
        
        .scan-item .time {
            color: #888;
            font-size: 12px;
        }
        
        .scan-item.error {
            border-left: 3px solid #f44336;
        }
        
        /* Manual Entry */
        .manual-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .manual-entry input {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #252542;
            color: white;
            font-size: 16px;
        }
        
        .manual-entry button {
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Connection indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connection-dot.connected {
            background: #4CAF50;
        }
        
        .connection-dot.disconnected {
            background: #f44336;
        }
        
        /* Chevron icon */
        .chevron {
            transition: transform 0.2s;
        }
        
        .setup-panel.collapsed .chevron {
            transform: rotate(-90deg);
        }
        
        /* Toggle switches */
        .toggles-row {
            display: flex;
            justify-content: space-around;
            background: #252542;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .toggle-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .toggle-item span {
            font-size: 11px;
            color: #888;
        }
        
        .toggle-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: #1a1a2e;
            color: #666;
        }
        
        .toggle-btn.active {
            background: #2d4a3e;
            color: #4CAF50;
        }
        
        /* Flash overlay for scan feedback */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
            transition: opacity 0.1s;
        }
        
        .flash-overlay.success {
            background: #4CAF50;
            animation: flash 0.4s ease-out;
        }
        
        .flash-overlay.error {
            background: #f44336;
            animation: flash 0.4s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }
        
        /* Big scan result popup */
        .scan-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: #1a1a2e;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease-out;
            border: 4px solid #4CAF50;
            min-width: 280px;
        }
        
        .scan-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .scan-popup.error {
            border-color: #f44336;
        }
        
        .scan-popup .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .scan-popup .direction-label {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .scan-popup .direction-label.in {
            color: #4CAF50;
        }
        
        .scan-popup .direction-label.out {
            color: #f44336;
        }
        
        .scan-popup .scan-id {
            font-size: 24px;
            color: #888;
        }
    </style>
</head>
<body>
    <!-- Flash overlay -->
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <!-- Scan popup -->
    <div class="scan-popup" id="scanPopup">
        <div class="icon" id="popupIcon">‚úì</div>
        <div class="direction-label in" id="popupDirection">IN</div>
        <div class="scan-id" id="popupId">PAR001</div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üö™ Door Scanner</h1>
            <div class="scan-count" id="scanCount">Scans: 0</div>
        </div>
        
        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <div class="setup-header" onclick="toggleSetup()">
                <h2>‚öôÔ∏è Setup</h2>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="setup-content">
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" placeholder="https://paworld-connect.azurewebsites.net/api">
                </div>
                <div class="form-group">
                    <label>API Key (if required)</label>
                    <input type="password" id="apiKey" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Event ID</label>
                    <input type="text" id="eventId" value="96fac9fe-58fc-47cd-989a-45641bec5f42">
                </div>
                <div class="form-group">
                    <label>Session ID (optional)</label>
                    <input type="text" id="sessionId" placeholder="Leave empty for event entry">
                </div>
                <div class="form-group">
                    <label>Scanner Name</label>
                    <input type="text" id="scannerName" value="PHONE_1">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save & Start</button>
            </div>
        </div>
        
        <!-- Direction Toggle -->
        <div class="direction-toggle">
            <button class="direction-btn in active" id="btnIn" onclick="setDirection('IN')">
                ‚û°Ô∏è IN
            </button>
            <button class="direction-btn out" id="btnOut" onclick="setDirection('OUT')">
                ‚¨ÖÔ∏è OUT
            </button>
        </div>
        
        <!-- Feedback Toggles -->
        <div class="toggles-row">
            <div class="toggle-item">
                <button class="toggle-btn active" id="toggleFlash" onclick="toggleFeedback('flash')">üí°</button>
                <span>Flash</span>
            </div>
            <div class="toggle-item">
                <button class="toggle-btn active" id="togglePopup" onclick="toggleFeedback('popup')">üì¢</button>
                <span>Popup</span>
            </div>
            <div class="toggle-item">
                <button class="toggle-btn active" id="toggleVibrate" onclick="toggleFeedback('vibrate')">üì≥</button>
                <span>Vibrate</span>
            </div>
            <div class="toggle-item">
                <button class="toggle-btn active" id="toggleBeep" onclick="toggleFeedback('beep')">üîä</button>
                <span>Beep</span>
            </div>
        </div>
        
        <!-- Scanner -->
        <div class="scanner-container">
            <div id="reader"></div>
        </div>
        
        <!-- Manual Entry -->
        <div class="manual-entry">
            <input type="text" id="manualId" placeholder="Enter badge ID manually">
            <button onclick="manualScan()">Scan</button>
        </div>
        
        <!-- Status -->
        <div class="status ready" id="status">
            Ready to scan
        </div>
        
        <!-- Recent Scans -->
        <div class="recent-scans">
            <h3>Recent Scans</h3>
            <div id="recentList">
                <div style="color: #666; text-align: center; padding: 20px;">
                    No scans yet
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let direction = 'IN';
        let scanCount = 0;
        let recentScans = [];
        let html5QrCode = null;
        let isScanning = false;
        let lastScanTime = 0;
        const SCAN_COOLDOWN = 2000; // 2 seconds between scans
        
        // Feedback settings
        let feedback = {
            flash: true,
            popup: true,
            vibrate: true,
            beep: true
        };
        
        // Settings
        let settings = {
            apiUrl: '',
            apiKey: '',
            eventId: '96fac9fe-58fc-47cd-989a-45641bec5f42',
            sessionId: '',
            scannerName: 'PHONE_1'
        };
        
        // Toggle feedback setting
        function toggleFeedback(type) {
            feedback[type] = !feedback[type];
            const btn = document.getElementById('toggle' + type.charAt(0).toUpperCase() + type.slice(1));
            btn.classList.toggle('active', feedback[type]);
            localStorage.setItem('doorScannerFeedback', JSON.stringify(feedback));
        }
        
        // Load feedback settings
        function loadFeedbackSettings() {
            const saved = localStorage.getItem('doorScannerFeedback');
            if (saved) {
                feedback = { ...feedback, ...JSON.parse(saved) };
                Object.keys(feedback).forEach(type => {
                    const btn = document.getElementById('toggle' + type.charAt(0).toUpperCase() + type.slice(1));
                    if (btn) btn.classList.toggle('active', feedback[type]);
                });
            }
        }
        
        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('doorScannerSettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
                document.getElementById('apiUrl').value = settings.apiUrl;
                document.getElementById('apiKey').value = settings.apiKey;
                document.getElementById('eventId').value = settings.eventId;
                document.getElementById('sessionId').value = settings.sessionId;
                document.getElementById('scannerName').value = settings.scannerName;
                
                // Auto-collapse if configured
                if (settings.apiUrl) {
                    document.getElementById('setupPanel').classList.add('collapsed');
                }
            }
        }
        
        // Save settings
        function saveSettings() {
            settings.apiUrl = document.getElementById('apiUrl').value.trim();
            settings.apiKey = document.getElementById('apiKey').value.trim();
            settings.eventId = document.getElementById('eventId').value.trim();
            settings.sessionId = document.getElementById('sessionId').value.trim();
            settings.scannerName = document.getElementById('scannerName').value.trim() || 'PHONE_1';
            
            localStorage.setItem('doorScannerSettings', JSON.stringify(settings));
            
            document.getElementById('setupPanel').classList.add('collapsed');
            startScanner();
            
            showStatus('Settings saved!', 'success');
        }
        
        // Toggle setup panel
        function toggleSetup() {
            document.getElementById('setupPanel').classList.toggle('collapsed');
        }
        
        // Set direction
        function setDirection(dir) {
            direction = dir;
            document.getElementById('btnIn').classList.toggle('active', dir === 'IN');
            document.getElementById('btnOut').classList.toggle('active', dir === 'OUT');
        }
        
        // Show status
        function showStatus(message, type = 'ready') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        // Flash the screen
        function flashScreen(success) {
            const overlay = document.getElementById('flashOverlay');
            overlay.classList.remove('success', 'error');
            void overlay.offsetWidth; // Force reflow to restart animation
            overlay.classList.add(success ? 'success' : 'error');
        }
        
        // Play beep sound
        function playBeep(success) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = success ? 880 : 220; // High beep for success, low for error
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.2);
            } catch (e) {
                // Audio not supported
            }
        }
        
        // Show scan popup
        function showScanPopup(scanValue, dir, success) {
            const popup = document.getElementById('scanPopup');
            const icon = document.getElementById('popupIcon');
            const dirLabel = document.getElementById('popupDirection');
            const idLabel = document.getElementById('popupId');
            
            icon.textContent = success ? '‚úì' : '‚úó';
            dirLabel.textContent = dir;
            dirLabel.className = 'direction-label ' + dir.toLowerCase();
            idLabel.textContent = scanValue;
            
            popup.classList.remove('error');
            if (!success) popup.classList.add('error');
            popup.style.borderColor = success ? (dir === 'IN' ? '#4CAF50' : '#f44336') : '#f44336';
            
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 1500);
        }
        
        // Process scan
        async function processScan(scanValue) {
            // Cooldown check
            const now = Date.now();
            if (now - lastScanTime < SCAN_COOLDOWN) {
                return;
            }
            lastScanTime = now;
            
            // Vibrate if enabled and supported
            if (feedback.vibrate && navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            showStatus(`Scanning: ${scanValue}...`, 'scanning');
            
            const scanData = {
                scanValue: scanValue,
                scannerName: settings.scannerName,
                entry: direction === 'IN',
                eventId: settings.eventId,
                sessionId: settings.sessionId || null
            };
            
            try {
                if (!settings.apiUrl) {
                    // Demo mode - just log locally
                    if (feedback.flash) flashScreen(true);
                    if (feedback.beep) playBeep(true);
                    if (feedback.popup) showScanPopup(scanValue, direction, true);
                    addToRecent(scanValue, direction, true);
                    showStatus(`‚úì ${direction}: ${scanValue}`, 'success');
                    return;
                }
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (settings.apiKey) {
                    headers['x-api-key'] = settings.apiKey;
                }
                
                const response = await fetch(`${settings.apiUrl}/DoorScan`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(scanData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (feedback.flash) flashScreen(true);
                    if (feedback.beep) playBeep(true);
                    if (feedback.popup) showScanPopup(scanValue, direction, true);
                    addToRecent(scanValue, direction, true);
                    showStatus(`‚úì ${direction}: ${scanValue}`, 'success');
                } else {
                    if (feedback.flash) flashScreen(false);
                    if (feedback.beep) playBeep(false);
                    if (feedback.popup) showScanPopup(scanValue, direction, false);
                    addToRecent(scanValue, direction, false, result.error);
                    showStatus(`‚úó Error: ${result.error}`, 'error');
                }
            } catch (error) {
                if (feedback.flash) flashScreen(false);
                if (feedback.beep) playBeep(false);
                if (feedback.popup) showScanPopup(scanValue, direction, false);
                addToRecent(scanValue, direction, false, error.message);
                showStatus(`‚úó Network error`, 'error');
                console.error('Scan error:', error);
            }
        }
        
        // Add to recent scans
        function addToRecent(scanValue, dir, success, error = null) {
            scanCount++;
            document.getElementById('scanCount').textContent = `Scans: ${scanCount}`;
            
            const time = new Date().toLocaleTimeString();
            recentScans.unshift({ scanValue, direction: dir, success, error, time });
            
            // Keep only last 10
            if (recentScans.length > 10) {
                recentScans.pop();
            }
            
            renderRecentScans();
        }
        
        // Render recent scans
        function renderRecentScans() {
            const list = document.getElementById('recentList');
            
            if (recentScans.length === 0) {
                list.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No scans yet</div>';
                return;
            }
            
            list.innerHTML = recentScans.map(scan => `
                <div class="scan-item ${scan.success ? '' : 'error'}">
                    <span class="direction ${scan.direction.toLowerCase()}">${scan.direction === 'IN' ? '‚óè' : '‚óã'}</span>
                    <span class="id">${scan.scanValue}</span>
                    <span class="time">${scan.time}</span>
                </div>
            `).join('');
        }
        
        // Manual scan
        function manualScan() {
            const input = document.getElementById('manualId');
            const value = input.value.trim();
            if (value) {
                processScan(value);
                input.value = '';
            }
        }
        
        // Handle Enter key in manual input
        document.getElementById('manualId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                manualScan();
            }
        });
        
        // Start camera scanner
        function startScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }
            
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    processScan(decodedText);
                },
                (errorMessage) => {
                    // Ignore scan errors (no QR in view)
                }
            ).then(() => {
                isScanning = true;
                showStatus('Ready to scan', 'ready');
            }).catch((err) => {
                console.error('Camera error:', err);
                showStatus('Camera access denied - use manual entry', 'error');
            });
        }
        
        // Initialize
        loadSettings();
        loadFeedbackSettings();
        
        // Auto-start scanner if settings exist
        if (settings.apiUrl || true) { // Always try to start
            setTimeout(startScanner, 500);
        }
    </script>
</body>
</html>
